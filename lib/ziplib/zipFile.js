var ZipEntry=require("./zipEntry"),Headers=require("./headers"),Utils=require("./util");module.exports=function(e,t){function n(){o={},a=new Array(c.diskEntries);for(var e=c.offset,t=0;t<a.length;t++){var n=e,r=new ZipEntry(h);r.header=h.slice(n,n+=Utils.Constants.CENHDR),r.entryName=h.slice(n,n+=r.header.fileNameLength),r.header.extraLength&&(r.extra=h.slice(n,n+=r.header.extraLength)),r.header.commentLength&&(r.comment=h.slice(n,n+r.header.commentLength)),e+=r.header.entryHeaderSize,a[t]=r,o[r.entryName]=r}}function r(){var e=h.length-Utils.Constants.ENDHDR,t=Math.max(0,e-65535),r=-1;for(e;e>=t;e--)if(80==h[e]&&h.readUInt32LE(e)==Utils.Constants.ENDSIG){r=e;break}if(!~r)throw Utils.Errors.INVALID_FORMAT;c.loadFromBinary(h.slice(r,r+Utils.Constants.ENDHDR)),c.commentLength&&(s=h.slice(r+Utils.Constants.ENDHDR)),n()}var a=[],o={},s=new Buffer(0),i="",f=require("fs"),h=null,c=new Headers.MainHeader;return t==Utils.Constants.FILE?(i=e,h=f.readFileSync(i),r()):t==Utils.Constants.BUFFER&&(h=e,r()),{get entries(){return a},get comment(){return s.toString()},set comment(e){c.commentLength=e.length,s=e},getEntry:function(e){return o[e]||null},setEntry:function(e){a.push(e),o[e.entryName]=e,c.totalEntries=a.length},deleteEntry:function(e){var t=o[e];if(t&&t.isDirectory){var n=this;this.getEntryChildren(t).forEach(function(t){t.entryName!=e&&n.deleteEntry(t.entryName)})}a.splice(a.indexOf(t),1),delete o[e],c.totalEntries=a.length},getEntryChildren:function(e){if(e.isDirectory){var t=[],n=e.entryName,r=n.length;return a.forEach(function(e){e.entryName.substr(0,r)==n&&t.push(e)}),t}return[]},compressToBuffer:function(){a.length>1&&a.sort(function(e,t){var n=e.entryName.toLowerCase(),r=t.entryName.toLowerCase();return r>n?-1:n>r?1:0});var e=0,t=[],n=[],r=0;c.size=0,c.offset=0,a.forEach(function(a){a.header.offset=r;var o=a.getCompressedData(),s=a.header.dataHeaderToBinary(),i=new Buffer(a.entryName+a.extra.toString()),f=s.length+i.length+o.length;r+=f,t.push(s),t.push(i),t.push(o);var h=a.packHeader();n.push(h),c.size+=h.length,e+=f+h.length}),e+=c.mainHeaderSize,c.offset=r,r=0;var o=new Buffer(e);t.forEach(function(e){e.copy(o,r),r+=e.length}),n.forEach(function(e){e.copy(o,r),r+=e.length});var i=c.toBinary();return s&&s.copy(i,Utils.Constants.ENDHDR),i.copy(o,r),o},toAsyncBuffer:function(e,t,n,r){a.length>1&&a.sort(function(e,t){var n=e.entryName.toLowerCase(),r=t.entryName.toLowerCase();return n>r?-1:r>n?1:0});var o=0,i=[],f=[],h=0;c.size=0,c.offset=0;var l=function(t){var a,l=arguments.callee;if(t.length){var a=t.pop(),u=a.entryName+a.extra.toString();n&&n(u),a.getCompressedDataAsync(function(n){r&&r(u),a.header.offset=h;var g=a.header.dataHeaderToBinary(),y=new Buffer(u),d=g.length+y.length+n.length;h+=d,i.push(g),i.push(y),i.push(n);var m=a.packHeader();if(f.push(m),c.size+=m.length,o+=d+m.length,t.length)l(t);else{o+=c.mainHeaderSize,c.offset=h,h=0;var p=new Buffer(o);i.forEach(function(e){e.copy(p,h),h+=e.length}),f.forEach(function(e){e.copy(p,h),h+=e.length});var E=c.toBinary();s&&s.copy(E,Utils.Constants.ENDHDR),E.copy(p,h),e(p)}})}};l(a)}}};